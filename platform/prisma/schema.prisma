// Event Management Platform - Prisma Schema
// Database: PostgreSQL
// Generated: 2025-12-28

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id     String  @id @default(cuid())
  email  String  @unique
  name   String?
  avatar String?

  // OAuth provider data
  provider      String    @default("google") // google, yandex, vk, email
  providerId    String? // External provider user ID
  emailVerified DateTime?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  participations Participant[]
  createdRooms   Room[]        @relation("RoomOrganizer")
  sessions       Session[]
  subscriptions  Subscription[]

  @@unique([provider, providerId])
  @@index([email])
  @@index([deletedAt])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime

  // Session metadata for security tracking
  deviceInfo String? // User agent or device description
  ipAddress  String? // IP address of session creation
  lastUsedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@index([expiresAt])
  @@index([lastUsedAt]) // For cleaning up stale sessions
  @@map("sessions")
}

model TokenBlacklist {
  id String @id @default(cuid())

  // Store hash of revoked access token (not the token itself)
  tokenHash String   @unique
  expiresAt DateTime

  // Revocation metadata
  userId    String
  reason    String? // logout, security_breach, manual_revoke, etc.
  revokedAt DateTime @default(now())
  revokedBy String? // Admin ID if manually revoked

  @@index([tokenHash]) // Fast lookup for validation
  @@index([expiresAt]) // For automatic cleanup of expired entries
  @@index([userId]) // Track user's revoked tokens
  @@map("token_blacklist")
}

// ============================================================================
// APPLICATIONS
// ============================================================================

model App {
  id        String @id @default(cuid())
  appId     String @unique // app_lottery_v1
  appSecret String @unique // sk_live_abc123...

  // Manifest versioning
  manifest        Json // Current manifest (JSON)
  manifestVersion String // Semantic version (e.g., "1.2.3")
  manifestHistory Json   @default("[]") // Array of previous manifest versions with metadata

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  rooms Room[]

  @@index([appId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([manifestVersion]) // Query by specific manifest version
  @@map("apps")
}

// ============================================================================
// ROOMS & EVENTS
// ============================================================================

enum RoomStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

model Room {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Application integration
  appId              String
  appSettings        Json // Application-specific settings validated against app manifest
  appManifestVersion String // Manifest version used when room was created (locks room to specific schema)

  // Status & visibility
  status   RoomStatus @default(DRAFT)
  isPublic Boolean    @default(true)

  // Organizer
  createdBy String

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  app          App           @relation(fields: [appId], references: [appId], onDelete: Restrict)
  organizer    User          @relation("RoomOrganizer", fields: [createdBy], references: [id], onDelete: Restrict)
  participants Participant[]
  prizes       Prize[]
  winners      Winner[]

  @@index([appId])
  @@index([status])
  @@index([isPublic])
  @@index([createdBy])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([appManifestVersion]) // Query rooms by manifest version
  @@index([status, isPublic, appId]) // Composite index for common queries
  @@index([appId, appManifestVersion]) // Query rooms by app and version
  @@map("rooms")
}

// ============================================================================
// PARTICIPANTS
// ============================================================================

enum ParticipantRole {
  ADMIN
  ORGANIZER
  MODERATOR
  PARTICIPANT
  VIEWER
}

model Participant {
  id     String          @id @default(cuid())
  userId String
  roomId String
  role   ParticipantRole @default(PARTICIPANT)

  // Application-specific metadata (e.g., ticketNumber, score, etc.)
  metadata Json?

  // Timestamps
  joinedAt  DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete (user left room)

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  room    Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  winners Winner[]

  @@unique([userId, roomId]) // User can only join room once
  @@index([roomId])
  @@index([userId])
  @@index([role])
  @@index([deletedAt])
  @@index([roomId, role]) // Common query pattern
  @@map("participants")
}

// ============================================================================
// PRIZES
// ============================================================================

model Prize {
  id          String  @id @default(cuid())
  roomId      String
  name        String
  description String?
  imageUrl    String?

  // Quantity tracking
  quantity          Int @default(1)
  quantityRemaining Int @default(1)

  // Application-specific metadata (e.g., value, sponsor, category)
  metadata Json?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  room    Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  winners Winner[]

  @@index([roomId])
  @@index([deletedAt])
  @@map("prizes")
}

// ============================================================================
// WINNERS
// ============================================================================

model Winner {
  id            String @id @default(cuid())
  roomId        String
  participantId String
  prizeId       String

  // Application-specific metadata (e.g., drawNumber, timestamp, algorithm)
  metadata Json?

  // Timestamps
  createdAt DateTime  @default(now())
  deletedAt DateTime? // Soft delete (winner revoked)

  // Relations
  room        Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  participant Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  prize       Prize       @relation(fields: [prizeId], references: [id], onDelete: Restrict)

  @@index([roomId])
  @@index([participantId])
  @@index([prizeId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([roomId, prizeId]) // Common query pattern
  @@map("winners")
}

// ============================================================================
// BILLING & SUBSCRIPTIONS
// ============================================================================

enum SubscriptionPlanTier {
  FREE
  PRO
  ENTERPRISE
  CUSTOM
}

enum SubscriptionStatus {
  TRIALING      // In trial period
  ACTIVE        // Subscription is active and paid
  PAST_DUE      // Payment failed, grace period
  CANCELED      // Canceled but still active until period end
  EXPIRED       // Subscription ended
  INCOMPLETE    // Initial payment not completed
  PAUSED        // Temporarily paused (optional feature)
}

enum BillingInterval {
  MONTHLY
  YEARLY
  LIFETIME
}

model SubscriptionPlan {
  id   String                @id @default(cuid())
  tier SubscriptionPlanTier

  // Plan details
  name        String // "Free Plan", "Pro Monthly", "Enterprise Yearly"
  description String?
  isActive    Boolean @default(true) // Can new users subscribe to this plan?

  // Pricing
  price           Int             @default(0) // Price in cents (e.g., 2999 = $29.99)
  currency        String          @default("USD")
  billingInterval BillingInterval @default(MONTHLY)

  // Feature limits (JSON for flexibility)
  features Json // { "maxRooms": 10, "maxParticipantsPerRoom": 100, "apps": ["app_lottery_v1"] }

  // Stripe integration (optional)
  stripePriceId   String? @unique // Stripe Price ID (price_xxx)
  stripeProductId String? // Stripe Product ID (prod_xxx)

  // Metadata
  displayOrder Int     @default(0) // For UI sorting (Free=0, Pro=1, Enterprise=2)
  metadata     Json    @default("{}") // Additional plan metadata

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete (keep for historical subscriptions)

  // Relations
  subscriptions Subscription[]

  @@unique([tier, billingInterval]) // One plan per tier+interval combination
  @@index([tier])
  @@index([isActive])
  @@index([deletedAt])
  @@index([displayOrder])
  @@map("subscription_plans")
}

model Subscription {
  id     String @id @default(cuid())
  userId String
  planId String

  // Subscription status
  status SubscriptionStatus @default(TRIALING)

  // Billing period
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Cancellation
  cancelAtPeriodEnd Boolean   @default(false)
  canceledAt        DateTime?
  cancelReason      String? // User feedback on cancellation

  // Trial
  trialStart DateTime?
  trialEnd   DateTime?

  // Stripe integration (optional)
  stripeCustomerId       String? // Stripe Customer ID (cus_xxx)
  stripeSubscriptionId   String? @unique // Stripe Subscription ID (sub_xxx)
  stripeCheckoutSessionId String? // Stripe Checkout Session ID (cs_xxx)

  // Usage tracking
  metadata Json @default("{}") // Track usage, overage, etc.

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete (keep subscription history)

  // Relations
  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  payments       Payment[]
  invoices       Invoice[]
  usageRecords   UsageRecord[]

  @@unique([userId, status, deletedAt]) // User can have only one active subscription
  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd]) // For expiration checks
  @@index([trialEnd]) // For trial expiration notifications
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([deletedAt])
  @@index([status, currentPeriodEnd]) // Common query pattern
  @@map("subscriptions")
}

model Payment {
  id             String @id @default(cuid())
  subscriptionId String
  userId         String

  // Payment details
  amount          Int    // Amount in cents
  currency        String @default("USD")
  status          String // succeeded, pending, failed, refunded
  paymentMethod   String? // card, bank_transfer, etc.
  failureReason   String? // Reason if payment failed

  // Stripe integration
  stripePaymentIntentId String? @unique // Stripe PaymentIntent ID (pi_xxx)
  stripeChargeId        String? // Stripe Charge ID (ch_xxx)

  // Metadata
  metadata Json @default("{}") // Additional payment info

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([stripePaymentIntentId])
  @@index([deletedAt])
  @@map("payments")
}

model Invoice {
  id             String @id @default(cuid())
  subscriptionId String
  userId         String

  // Invoice details
  invoiceNumber String  @unique // INV-2025-001
  amount        Int // Amount in cents
  currency      String  @default("USD")
  status        String // draft, open, paid, void, uncollectible

  // Dates
  issuedAt DateTime @default(now())
  dueAt    DateTime
  paidAt   DateTime?

  // Stripe integration
  stripeInvoiceId String? @unique // Stripe Invoice ID (in_xxx)

  // PDF
  pdfUrl String? // URL to generated invoice PDF

  // Line items
  lineItems Json @default("[]") // Array of invoice line items

  // Metadata
  metadata Json @default("{}") // Additional invoice info

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([userId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([issuedAt])
  @@index([dueAt])
  @@index([stripeInvoiceId])
  @@index([deletedAt])
  @@map("invoices")
}

model UsageRecord {
  id             String @id @default(cuid())
  subscriptionId String
  userId         String

  // Usage tracking
  metricName  String // "rooms_created", "participants_added", "api_calls"
  quantity    Int // Number of units used
  timestamp   DateTime @default(now())

  // Metadata
  metadata Json @default("{}") // Additional context (roomId, appId, etc.)

  // Timestamps
  createdAt DateTime  @default(now())
  deletedAt DateTime? // Soft delete

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([userId])
  @@index([metricName])
  @@index([timestamp])
  @@index([deletedAt])
  @@index([subscriptionId, metricName, timestamp]) // For aggregation queries
  @@map("usage_records")
}
